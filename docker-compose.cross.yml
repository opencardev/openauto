# Modern Docker Compose specification (no version needed)
name: openauto-cross-compile

services:
  # ARMhf (32-bit ARM) build environment
  build-armhf:
    build:
      context: .
      dockerfile: Dockerfile.cross
      args:
        DEBIAN_RELEASE: trixie
        TARGET_ARCH: armhf
        BUILD_TESTS: "false"
      platforms:
        - linux/arm/v7
    volumes:
      - type: bind
        source: .
        target: /src
      - type: bind
        source: ./artifacts/armhf
        target: /output
        bind:
          create_host_path: true
    environment:
      TARGET_ARCH: armhf
      BUILD_TESTS: "false"
    profiles:
      - armhf
      - all
    deploy:
      resources:
        limits:
          memory: 2G

  # ARM64 (64-bit ARM) build environment  
  build-arm64:
    build:
      context: .
      dockerfile: Dockerfile.cross
      args:
        DEBIAN_RELEASE: trixie
        TARGET_ARCH: arm64
        BUILD_TESTS: "false"
      platforms:
        - linux/arm64
    volumes:
      - type: bind
        source: .
        target: /src
      - type: bind
        source: ./artifacts/arm64
        target: /output
        bind:
          create_host_path: true
    environment:
      TARGET_ARCH: arm64
      BUILD_TESTS: "false"
    profiles:
      - arm64
      - all
    deploy:
      resources:
        limits:
          memory: 2G

  # Development environment for testing
  dev-armhf:
    build:
      context: .
      dockerfile: Dockerfile.cross
      args:
        DEBIAN_RELEASE: trixie
        TARGET_ARCH: armhf
        BUILD_TESTS: "true"
      platforms:
        - linux/arm/v7
    volumes:
      - type: bind
        source: .
        target: /src
        bind:
          create_host_path: true
      - type: bind
        source: ./artifacts/armhf-dev
        target: /output
        bind:
          create_host_path: true
    environment:
      TARGET_ARCH: armhf
      BUILD_TESTS: "true"
    command: /bin/bash
    stdin_open: true
    tty: true
    profiles:
      - dev
    deploy:
      resources:
        limits:
          memory: 2G