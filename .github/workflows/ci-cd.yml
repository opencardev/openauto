name: CI/CD Pipeline - Unified

on:
  push:
    branches: [ main, develop, crankshaft-ng_2025 ]
    tags: [ 'v*', 'release-*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
          - Debug
          - Release
      target_architectures:
        description: 'Target architectures (comma-separated: amd64,arm64,armhf or all)'
        required: false
        default: 'all'
        type: string
      create_release:
        description: 'Create release after build'
        required: false
        default: false
        type: boolean
      release_type:
        description: 'Release type (if creating release)'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      run_tests:
        description: 'Run comprehensive tests'
        required: false
        default: true
        type: boolean
      run_security_scan:
        description: 'Run security scanning'
        required: false
        default: true
        type: boolean

env:
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'Release' }}
  DEBIAN_FRONTEND: noninteractive

jobs:
  # Generate version information
  version:
    name: Generate Version Info
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_date: ${{ steps.version.outputs.build_date }}
      git_commit: ${{ steps.version.outputs.git_commit }}
      git_branch: ${{ steps.version.outputs.git_branch }}
      package_version: ${{ steps.version.outputs.package_version }}
      is_release: ${{ steps.version.outputs.is_release }}
      should_create_packages: ${{ steps.version.outputs.should_create_packages }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version information
        id: version
        run: |
          # Date-based versioning: YYYY.MM.DD+commit
          BUILD_DATE=$(date +%Y.%m.%d)
          GIT_COMMIT=$(git rev-parse --short HEAD)
          GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          VERSION="${BUILD_DATE}+${GIT_COMMIT}"
          
          # For packaging, replace + with ~ for Debian compatibility
          PACKAGE_VERSION="${BUILD_DATE}~${GIT_COMMIT}"
          
          # Determine if this is a release
          IS_RELEASE="false"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            IS_RELEASE="true"
          fi
          
          # Determine if we should create packages (tags, main/develop pushes, or manual with create_release)
          SHOULD_CREATE_PACKAGES="false"
          if [[ "$IS_RELEASE" == "true" ]] || [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/heads/* ]] || [[ "${{ github.event.inputs.create_release }}" == "true" ]]; then
            SHOULD_CREATE_PACKAGES="true"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          echo "git_commit=${GIT_COMMIT}" >> $GITHUB_OUTPUT
          echo "git_branch=${GIT_BRANCH}" >> $GITHUB_OUTPUT
          echo "package_version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "is_release=${IS_RELEASE}" >> $GITHUB_OUTPUT
          echo "should_create_packages=${SHOULD_CREATE_PACKAGES}" >> $GITHUB_OUTPUT
          
          echo "Generated version: ${VERSION}"
          echo "Package version: ${PACKAGE_VERSION}"
          echo "Is release: ${IS_RELEASE}"
          echo "Should create packages: ${SHOULD_CREATE_PACKAGES}"

  # Code quality and security checks
  code-quality:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup C++ environment
        uses: aminya/setup-cpp@v1
        with:
          compiler: gcc
          vcvarsall: false
          cmake: true
          ninja: true
          cppcheck: true
          clang-format: true

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/ccache
            build/_deps
          key: ${{ runner.os }}-deps-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Run cppcheck (static analysis)
        run: |
          cppcheck --enable=all --std=c++17 --xml --xml-version=2 \
            --suppress=missingIncludeSystem \
            --suppress=unmatchedSuppression \
            --suppress=unusedFunction \
            src/ include/ 2> cppcheck-report.xml || true

      - name: Upload cppcheck results
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: cppcheck-report.xml

      - name: Check code formatting
        run: |
          find src include tests -name "*.cpp" -o -name "*.hpp" -o -name "*.h" | \
          xargs clang-format --dry-run --Werror

      - name: Run pre-commit hooks
        uses: pre-commit/action@v3.0.0
        continue-on-error: true

  # Build and test matrix for development
  build-test:
    name: Build & Test (${{ matrix.os }}, ${{ matrix.compiler }})
    needs: [version, code-quality]
    if: github.event.inputs.run_tests != 'false'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-20.04]
        compiler: [gcc-9, gcc-11, clang-12]
        exclude:
          - os: ubuntu-20.04
            compiler: gcc-11
        include:
          - os: ubuntu-22.04
            compiler: gcc-9
            coverage: true

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup compiler
        run: |
          if [[ "${{ matrix.compiler }}" == gcc-* ]]; then
            version=${COMPILER#gcc-}
            sudo apt-get update
            sudo apt-get install -y gcc-${version} g++-${version}
            echo "CC=gcc-${version}" >> $GITHUB_ENV
            echo "CXX=g++-${version}" >> $GITHUB_ENV
          elif [[ "${{ matrix.compiler }}" == clang-* ]]; then
            version=${COMPILER#clang-}
            sudo apt-get update
            sudo apt-get install -y clang-${version}
            echo "CC=clang-${version}" >> $GITHUB_ENV
            echo "CXX=clang++-${version}" >> $GITHUB_ENV
          fi
        env:
          COMPILER: ${{ matrix.compiler }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            pkg-config \
            libboost-all-dev \
            libprotobuf-dev \
            protobuf-compiler \
            nlohmann-json3-dev \
            qtbase5-dev \
            qtmultimedia5-dev \
            qtdeclarative5-dev \
            qtquickcontrols2-5-dev \
            libusb-1.0-0-dev \
            libtag1-dev \
            librtaudio-dev \
            libasound2-dev \
            libpulse-dev

      - name: Build AASDK
        run: |
          git clone https://github.com/opencardev/aasdk.git /tmp/aasdk
          cd /tmp/aasdk
          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DTARGET_ARCH=amd64 \
            -GNinja
          ninja -j$(nproc)
          sudo ninja install
          sudo ldconfig

      - name: Configure CMake
        run: |
          cmake -B build -S . \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_STANDARD=17 \
            -DNOPI=ON \
            -DENABLE_MODERN_API=ON \
            -DENABLE_CS_PARAM_CALLS=OFF \
            -GNinja

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run tests
        if: env.BUILD_TYPE == 'Debug'
        run: ctest --test-dir build --output-on-failure

      - name: Generate coverage report
        if: matrix.coverage && env.BUILD_TYPE == 'Debug'
        run: |
          sudo apt-get install -y lcov
          lcov --capture --directory build --output-file coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --list coverage.info

      - name: Upload coverage
        if: matrix.coverage && env.BUILD_TYPE == 'Debug'
        uses: codecov/codecov-action@v3
        with:
          file: coverage.info

  # Security scanning
  security-scan:
    name: Security Scan
    needs: code-quality
    runs-on: ubuntu-latest
    if: github.event.inputs.run_security_scan != 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # Production package building
  build-packages:
    name: Build Packages (${{ matrix.arch }})
    needs: [version, code-quality]
    if: needs.version.outputs.should_create_packages == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            target: x86_64-linux-gnu
          - arch: arm64
            platform: linux/arm64
            target: aarch64-linux-gnu
          - arch: armhf
            platform: linux/arm/v7
            target: arm-linux-gnueabihf

    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if architecture should be built
        id: check_arch
        run: |
          TARGET_ARCHS="${{ github.event.inputs.target_architectures || 'all' }}"
          if [[ "$TARGET_ARCHS" == "all" ]] || [[ "$TARGET_ARCHS" == *"${{ matrix.arch }}"* ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up QEMU
        if: steps.check_arch.outputs.should_build == 'true' && matrix.arch != 'amd64'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.check_arch.outputs.should_build == 'true' && matrix.arch != 'amd64'
        uses: docker/setup-buildx-action@v3

      - name: Install dependencies (AMD64 only)
        if: steps.check_arch.outputs.should_build == 'true' && matrix.arch == 'amd64'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            pkg-config \
            libboost-all-dev \
            libprotobuf-dev \
            protobuf-compiler \
            nlohmann-json3-dev \
            qtbase5-dev \
            qtmultimedia5-dev \
            qtdeclarative5-dev \
            qtquickcontrols2-5-dev \
            libusb-1.0-0-dev \
            libtag1-dev \
            librtaudio-dev \
            libasound2-dev \
            libpulse-dev \
            debhelper \
            fakeroot \
            devscripts

      - name: Build AASDK (AMD64 only)
        if: steps.check_arch.outputs.should_build == 'true' && matrix.arch == 'amd64'
        run: |
          git clone https://github.com/opencardev/aasdk.git /tmp/aasdk
          cd /tmp/aasdk
          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DTARGET_ARCH=amd64 \
            -GNinja
          ninja -j$(nproc)
          sudo ninja install
          sudo ldconfig

      - name: Build native package (AMD64)
        if: steps.check_arch.outputs.should_build == 'true' && matrix.arch == 'amd64'
        run: |
          # Configure build
          cmake -B build-${{ matrix.arch }} -S . \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_STANDARD=17 \
            -DNOPI=ON \
            -DENABLE_MODERN_API=ON \
            -DENABLE_CS_PARAM_CALLS=OFF \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -GNinja

          # Build
          cmake --build build-${{ matrix.arch }} --parallel $(nproc)

          # Create package directory structure
          mkdir -p packages/${{ matrix.arch }}
          DESTDIR=$(pwd)/packages/${{ matrix.arch }}/install cmake --install build-${{ matrix.arch }}

          # Build Debian package
          cd packages/${{ matrix.arch }}
          mkdir -p DEBIAN
          
          # Create control file
          cat > DEBIAN/control << EOF
          Package: openauto-modern
          Version: ${{ needs.version.outputs.package_version }}
          Section: multimedia
          Priority: optional
          Architecture: ${{ matrix.arch }}
          Depends: libboost-all-dev, libprotobuf32, qtbase5-dev, qtmultimedia5-dev, qtdeclarative5-dev, qtquickcontrols2-5-dev, libusb-1.0-0, libtag1v5, librtaudio6, libasound2, libpulse0
          Maintainer: OpenCarDev Team <team@opencardev.com>
          Description: Modern Android Auto implementation
           OpenAuto is a modern implementation of Android Auto head unit emulator.
           .
           This package provides the main application and all required components
           to run Android Auto on various hardware platforms.
          EOF

          # Create postinst script
          cat > DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          if [ "$1" = "configure" ]; then
              # Set up udev rules
              udevadm control --reload-rules
              udevadm trigger
              
              # Create openauto user if not exists
              if ! id "openauto" &>/dev/null; then
                  useradd -r -s /bin/false openauto
              fi
              
              # Set permissions
              chown -R openauto:openauto /etc/openauto || true
              chmod +x /usr/bin/autoapp || true
          fi
          EOF
          chmod +x DEBIAN/postinst

          # Create the package
          cd ..
          dpkg-deb --build ${{ matrix.arch }} openauto-modern_${{ needs.version.outputs.package_version }}_${{ matrix.arch }}.deb

      - name: Cross-compile package (ARM)
        if: steps.check_arch.outputs.should_build == 'true' && matrix.arch != 'amd64'
        run: |
          # Create Dockerfile for cross-compilation
          cat > Dockerfile.cross << EOF
          FROM --platform=${{ matrix.platform }} ubuntu:22.04

          # Install build dependencies
          RUN apt-get update && apt-get install -y \\
              build-essential \\
              cmake \\
              ninja-build \\
              pkg-config \\
              libboost-all-dev \\
              libprotobuf-dev \\
              protobuf-compiler \\
              nlohmann-json3-dev \\
              qtbase5-dev \\
              qtmultimedia5-dev \\
              qtdeclarative5-dev \\
              qtquickcontrols2-5-dev \\
              libusb-1.0-0-dev \\
              libtag1-dev \\
              librtaudio-dev \\
              libasound2-dev \\
              libpulse-dev \\
              debhelper \\
              fakeroot \\
              devscripts \\
              git \\
              && rm -rf /var/lib/apt/lists/*

          WORKDIR /workspace
          EOF

          # Build cross-compilation image
          docker build -f Dockerfile.cross -t openauto-cross-${{ matrix.arch }} .

          # Cross-compile in container
          docker run --rm --platform=${{ matrix.platform }} \
            -v $(pwd):/workspace \
            openauto-cross-${{ matrix.arch }} \
            bash -c "
              # Build AASDK
              git clone https://github.com/opencardev/aasdk.git /tmp/aasdk
              cd /tmp/aasdk
              mkdir build && cd build
              cmake .. \\
                -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \\
                -DCMAKE_CXX_STANDARD=17 \\
                -DCMAKE_INSTALL_PREFIX=/usr/local \\
                -DCMAKE_SYSTEM_NAME=Linux \\
                -DCMAKE_SYSTEM_PROCESSOR=${{ matrix.arch == 'arm64' && 'aarch64' || 'arm' }} \\
                -DCMAKE_C_COMPILER=${{ matrix.target }}-gcc \\
                -DCMAKE_CXX_COMPILER=${{ matrix.target }}-g++ \\
                -DTARGET_ARCH=${{ matrix.arch }} \\
                -GNinja
              ninja -j\$(nproc)
              ninja install
              ldconfig

              # Build OpenAuto
              cd /workspace
              cmake -B build-${{ matrix.arch }} -S . \\
                -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \\
                -DCMAKE_CXX_STANDARD=17 \\
                -DNOPI=ON \\
                -DENABLE_MODERN_API=ON \\
                -DENABLE_CS_PARAM_CALLS=OFF \\
                -DCMAKE_INSTALL_PREFIX=/usr \\
                -DCMAKE_SYSTEM_NAME=Linux \\
                -DCMAKE_SYSTEM_PROCESSOR=${{ matrix.arch == 'arm64' && 'aarch64' || 'arm' }} \\
                -DCMAKE_C_COMPILER=${{ matrix.target }}-gcc \\
                -DCMAKE_CXX_COMPILER=${{ matrix.target }}-g++ \\
                -GNinja

              cmake --build build-${{ matrix.arch }} --parallel \$(nproc)

              # Create package
              mkdir -p packages/${{ matrix.arch }}
              DESTDIR=\$(pwd)/packages/${{ matrix.arch }}/install cmake --install build-${{ matrix.arch }}

              cd packages/${{ matrix.arch }}
              mkdir -p DEBIAN

              cat > DEBIAN/control << 'EOFCTRL'
          Package: openauto-modern
          Version: ${{ needs.version.outputs.package_version }}
          Section: multimedia
          Priority: optional
          Architecture: ${{ matrix.arch }}
          Depends: libboost-all-dev, libprotobuf32, qtbase5-dev, qtmultimedia5-dev, qtdeclarative5-dev, qtquickcontrols2-5-dev, libusb-1.0-0, libtag1v5, librtaudio6, libasound2, libpulse0
          Maintainer: OpenCarDev Team <team@opencardev.com>
          Description: Modern Android Auto implementation
           OpenAuto is a modern implementation of Android Auto head unit emulator.
           .
           This package provides the main application and all required components
           to run Android Auto on various hardware platforms.
          EOFCTRL

              cat > DEBIAN/postinst << 'EOFPOST'
          #!/bin/bash
          set -e
          if [ \"\$1\" = \"configure\" ]; then
              udevadm control --reload-rules
              udevadm trigger
              
              if ! id \"openauto\" &>/dev/null; then
                  useradd -r -s /bin/false openauto
              fi
              
              chown -R openauto:openauto /etc/openauto || true
              chmod +x /usr/bin/autoapp || true
          fi
          EOFPOST
              chmod +x DEBIAN/postinst

              cd ..
              dpkg-deb --build ${{ matrix.arch }} openauto-modern_${{ needs.version.outputs.package_version }}_${{ matrix.arch }}.deb
            "

      - name: Upload package artifacts
        if: steps.check_arch.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.arch }}
          path: packages/openauto-modern_${{ needs.version.outputs.package_version }}_${{ matrix.arch }}.deb

  # Package validation
  validate-packages:
    name: Validate Packages
    needs: [version, build-packages]
    if: needs.version.outputs.should_create_packages == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download package artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages/

      - name: Install validation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y lintian file

      - name: Validate packages
        run: |
          for pkg in packages/*/openauto-modern_*.deb; do
            if [ -f "$pkg" ]; then
              echo "Validating $pkg"
              
              # Basic file checks
              file "$pkg"
              dpkg-deb --info "$pkg"
              dpkg-deb --contents "$pkg"
              
              # Lintian checks
              lintian "$pkg" || true
              
              echo "Package $pkg validated successfully"
            fi
          done

      - name: Test installation
        run: |
          for pkg in packages/*/openauto-modern_*.deb; do
            if [ -f "$pkg" ] && [[ "$pkg" == *"amd64"* ]]; then
              echo "Testing installation of $pkg"
              sudo dpkg -i "$pkg" || true
              sudo apt-get install -f -y || true
              break
            fi
          done

  # Create release
  create-release:
    name: Create Release
    needs: [version, build-packages, validate-packages]
    if: needs.version.outputs.is_release == 'true' || github.event.inputs.create_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all package artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages/

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Move all packages to release assets
          find packages/ -name "*.deb" -exec cp {} release-assets/ \;
          
          # Generate checksums
          cd release-assets
          sha256sum *.deb > checksums.sha256
          
          # Create package inventory
          cat > package-inventory.md << EOF
          # Package Inventory - ${{ needs.version.outputs.version }}
          
          ## Available Packages
          
          | Package | Architecture | Size | SHA256 |
          |---------|--------------|------|--------|
          EOF
          
          for pkg in *.deb; do
            if [ -f "$pkg" ]; then
              size=$(du -h "$pkg" | cut -f1)
              sha=$(sha256sum "$pkg" | cut -d' ' -f1)
              arch=$(echo "$pkg" | grep -o '_[^_]*\.deb$' | sed 's/_\|\.deb//g')
              echo "| $pkg | $arch | $size | \`$sha\` |" >> package-inventory.md
            fi
          done

      - name: Generate release notes
        id: release_notes
        run: |
          # Read release template
          if [ -f ".github/RELEASE_TEMPLATE.md" ]; then
            cp .github/RELEASE_TEMPLATE.md release_notes.md
          else
            cat > release_notes.md << EOF
          # OpenAuto ${{ needs.version.outputs.version }}
          
          ## What's New
          
          ### Features & Improvements
          - Updated to use OpenCarDev AASDK repository
          - Enhanced multi-architecture support
          - Improved build system and packaging
          
          ### Bug Fixes
          - Various stability improvements
          - Build system fixes
          
          ## Installation
          
          Download the appropriate package for your architecture:
          - **AMD64** (x86_64): For desktop PCs and Intel/AMD servers
          - **ARM64** (AArch64): For Raspberry Pi 4/5 and ARM64 SBCs
          - **ARMHF** (ARM hard float): For Raspberry Pi 3 and ARM32 SBCs
          
          \`\`\`bash
          # Download and install (replace with your architecture)
          wget https://github.com/opencardev/openauto/releases/download/${{ github.ref_name }}/openauto-modern_${{ needs.version.outputs.package_version }}_amd64.deb
          sudo dpkg -i openauto-modern_${{ needs.version.outputs.package_version }}_amd64.deb
          sudo apt-get install -f  # Install any missing dependencies
          \`\`\`
          
          ## System Requirements
          
          - Ubuntu 20.04 LTS or later
          - Qt5 libraries
          - Boost libraries
          - libusb-1.0
          - Compatible Android device with Android Auto
          
          ## Changelog
          
          EOF
          
          # Add recent commits
          git log --oneline --max-count=20 >> release_notes.md
          fi
          
          # Replace template variables
          sed -i "s/{{VERSION}}/${{ needs.version.outputs.version }}/g" release_notes.md
          sed -i "s/{{BUILD_DATE}}/${{ needs.version.outputs.build_date }}/g" release_notes.md
          sed -i "s/{{GIT_COMMIT}}/${{ needs.version.outputs.git_commit }}/g" release_notes.md
          sed -i "s/{{GIT_BRANCH}}/${{ needs.version.outputs.git_branch }}/g" release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: OpenAuto ${{ needs.version.outputs.version }}
          body_path: release_notes.md
          files: |
            release-assets/*.deb
            release-assets/checksums.sha256
            release-assets/package-inventory.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Post-release tasks
  post-release:
    name: Post-Release Tasks
    needs: [version, create-release]
    if: needs.version.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update package repositories
        run: |
          echo "Post-release tasks completed"
          echo "Release ${{ needs.version.outputs.version }} has been published"
